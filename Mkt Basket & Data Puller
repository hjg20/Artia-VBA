Sub MarketBasketMaker()
'
' MarketBasketMaker Macro
'
' Keyboard Shortcut: Ctrl+Shift+P
'
    Range("A:A").Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
        
    Range("A1").FormulaR1C1 = "NDC11"
    Range("A2").FormulaR1C1 = "=SUBSTITUTE(RC[1],""-"","""")"
    Range("A2").Select
    Selection.AutoFill Destination:=Range("A2:A" & Range("B" & Rows.Count).End(xlUp).Row)
    Range(Selection, Selection.End(xlDown)).Select
    
    Columns("A:A").EntireColumn.AutoFit
    
    Columns("A:A").Copy
    Columns("A:A").PasteSpecial xlPasteValues
    
    Range("A:A").Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    
    Range("A1") = "Duplicates"
    Range("A2").Formula = "=IF(COUNTIF(B:B, B2)>1,""DUPLICATE"","""")"
    Range("A2").Select
    Selection.AutoFill Destination:=Range("A2:A" & Range("B" & Rows.Count).End(xlUp).Row)
    Range(Selection, Selection.End(xlDown)).Select
    
    Range("F:F").Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Range("F1") = "ProductName2"
    Dim SingleValue() As String
    For k = 2 To Application.WorksheetFunction.CountA(Columns(1))
        SingleValue = Split(Range("E" & k), " ")
        Range("F" & k).Value = SingleValue(0)
    Next k
    
    ActiveWindow.LargeScroll ToRight:=-99
    Range("G2").Select
    ActiveWindow.FreezePanes = True
    
    Cells.Columns.AutoFit
    
    ActiveSheet.Name = "Sheet1"
    Range("A1").EntireRow.AutoFilter
    ActiveWindow.LargeScroll Down:=-99
    

    
    
End Sub

Sub DataPuller()
'
' DataPuller Macro
'
' Keyboard Shortcut: Ctrl+Shift+D
'
Dim refresh
Dim year As String
Dim quarters As ListObject
Dim intColIndex As Integer

Dim strPath As String
Dim strProv As String
Dim strConn As String
Dim Conn As New Connection
Dim rsQry As New Recordset
Dim strQry As String
Dim NDCs As Range
Dim CMS As String
Dim pool As String
Dim mb As String
Dim ProductName2s As Range
Dim ws As Worksheet
Dim financial



year = Application.InputBox("Which year would you like CMS Utilization Data from:" & vbNewLine & "2019-2023 (or r2q for most recent 2 quarters)?", "Input Year")

If year = "2023" Then

    financial = MsgBox("Would you like Financial Data?", vbYesNo)
    If financial = vbNo Then
        CMS = "[1Q2023 - 4Q2023 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_without_financials"
        
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2023 - 4Q2023 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
    If financial = vbYes Then
        CMS = "[1Q2023 - 4Q2023 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_with_financials"
    
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2023 - 4Q2023 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice]) "
        strQry = strQry & "SELECT NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice] "
        strQry = strQry & "FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount], " & mb & ".[BrandGenericStatus], " & mb & ".[LicenseTypeName], " & mb & ".[AWPUnitPrice], " & mb & ".[WACUnitPrice], " & mb & ".[est_ura], " & mb & ".[ACA-FULUnitPrice], " & mb & ".[ACA-WAMPUnitPrice], " & mb & ".[NADAC-MonUnitPrice], " & mb & ".[NADAC-WKUnitPrice]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Range("M1") = "BrandGenericStatus"
        ws.Range("N1") = "LicenseTypeName"
        ws.Range("O1") = "AWPUnitPrice"
        ws.Range("P1") = "WACUnitPrice"
        ws.Range("Q1") = "est_ura"
        ws.Range("R1") = "ACA-FULUnitPrice"
        ws.Range("S1") = "ACA-WAMPUnitPrice"
        ws.Range("T1") = "NADAC-MonUnitPrice"
        ws.Range("U1") = "NADAC-WKUnitPrice"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
End If

If year = "2022" Then

    financial = MsgBox("Would you like Financial Data?", vbYesNo)
    If financial = vbNo Then
        CMS = "[1Q2022 - 4Q2022 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_without_financials"
        
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2022 - 4Q2022 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
    If financial = vbYes Then
        CMS = "[1Q2022 - 4Q2022 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_with_financials"
    
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2022 - 4Q2022 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice]) "
        strQry = strQry & "SELECT NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice] "
        strQry = strQry & "FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount], " & mb & ".[BrandGenericStatus], " & mb & ".[LicenseTypeName], " & mb & ".[AWPUnitPrice], " & mb & ".[WACUnitPrice], " & mb & ".[est_ura], " & mb & ".[ACA-FULUnitPrice], " & mb & ".[ACA-WAMPUnitPrice], " & mb & ".[NADAC-MonUnitPrice], " & mb & ".[NADAC-WKUnitPrice]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Range("M1") = "BrandGenericStatus"
        ws.Range("N1") = "LicenseTypeName"
        ws.Range("O1") = "AWPUnitPrice"
        ws.Range("P1") = "WACUnitPrice"
        ws.Range("Q1") = "est_ura"
        ws.Range("R1") = "ACA-FULUnitPrice"
        ws.Range("S1") = "ACA-WAMPUnitPrice"
        ws.Range("T1") = "NADAC-MonUnitPrice"
        ws.Range("U1") = "NADAC-WKUnitPrice"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
End If
If year = "2021" Then

    financial = MsgBox("Would you like Financial Data?", vbYesNo)
    If financial = vbNo Then
        CMS = "[1Q2021 - 4Q2021 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_without_financials"
        
        'strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2021 - 4Q2021 CMS Utilization Database.accdb"
        strPath = "C:\Users\hgarrison\Documents\PRM DOCS\1Q2021 - 4Q2021 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
    If financial = vbYes Then
        CMS = "[1Q2021 - 4Q2021 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_with_financials"
    
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2021 - 4Q2021 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice]) "
        strQry = strQry & "SELECT NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice] "
        strQry = strQry & "FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount], " & mb & ".[BrandGenericStatus], " & mb & ".[LicenseTypeName], " & mb & ".[AWPUnitPrice], " & mb & ".[WACUnitPrice], " & mb & ".[est_ura], " & mb & ".[ACA-FULUnitPrice], " & mb & ".[ACA-WAMPUnitPrice], " & mb & ".[NADAC-MonUnitPrice], " & mb & ".[NADAC-WKUnitPrice]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Range("M1") = "BrandGenericStatus"
        ws.Range("N1") = "LicenseTypeName"
        ws.Range("O1") = "AWPUnitPrice"
        ws.Range("P1") = "WACUnitPrice"
        ws.Range("Q1") = "est_ura"
        ws.Range("R1") = "ACA-FULUnitPrice"
        ws.Range("S1") = "ACA-WAMPUnitPrice"
        ws.Range("T1") = "NADAC-MonUnitPrice"
        ws.Range("U1") = "NADAC-WKUnitPrice"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
End If
If year = "2020" Then

    financial = MsgBox("Would you like Financial Data?", vbYesNo)
    If financial = vbNo Then
        CMS = "[1Q2020 - 4Q2020 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_without_financials"
        
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2020 - 4Q2020 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[record_id], " & CMS & ".[state_code], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[ndc], " & CMS & ".[quarter], " & CMS & ".[period_covered], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[units_reimbursed], " & CMS & ".[number_of_prescriptions], " & CMS & ".[total_amount_reimbursed]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[state_code]) ON [" & mb & "].[NDC11] = " & CMS & ".[ndc]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
    If financial = vbYes Then
        CMS = "[1Q2020 - 4Q2020 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_with_financials"
    
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2020 - 4Q2020 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice]) "
        strQry = strQry & "SELECT NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice] "
        strQry = strQry & "FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[record_id], " & CMS & ".[state_code], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[ndc], " & CMS & ".[quarter], " & CMS & ".[period_covered], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[units_reimbursed], " & CMS & ".[number_of_prescriptions], " & CMS & ".[total_amount_reimbursed], " & mb & ".[BrandGenericStatus], " & mb & ".[LicenseTypeName], " & mb & ".[AWPUnitPrice], " & mb & ".[WACUnitPrice], " & mb & ".[est_ura], " & mb & ".[ACA-FULUnitPrice], " & mb & ".[ACA-WAMPUnitPrice], " & mb & ".[NADAC-MonUnitPrice], " & mb & ".[NADAC-WKUnitPrice]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[state_code]) ON [" & mb & "].[NDC11] = " & CMS & ".[ndc]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Range("M1") = "BrandGenericStatus"
        ws.Range("N1") = "LicenseTypeName"
        ws.Range("O1") = "AWPUnitPrice"
        ws.Range("P1") = "WACUnitPrice"
        ws.Range("Q1") = "est_ura"
        ws.Range("R1") = "ACA-FULUnitPrice"
        ws.Range("S1") = "ACA-WAMPUnitPrice"
        ws.Range("T1") = "NADAC-MonUnitPrice"
        ws.Range("U1") = "NADAC-WKUnitPrice"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
End If
If year = "2019" Then

financial = MsgBox("Would you like Financial Data?", vbYesNo)
    If financial = vbNo Then
        CMS = "[1Q2019 - 4Q2019 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_without_financials"
        
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2019 - 4Q2019 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[record_id], " & CMS & ".[state_code], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[ndc], " & CMS & ".[quarter], " & CMS & ".[period_covered], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[units_reimbursed], " & CMS & ".[number_of_prescriptions], " & CMS & ".[total_amount_reimbursed]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[state_code]) ON [" & mb & "].[NDC11] = " & CMS & ".[ndc]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
    If financial = vbYes Then
        CMS = "[1Q2019 - 4Q2019 CMS Utilization Data]"
        pool = "[State Pools June 2023]"
        mb = "MB_with_financials"
    
        strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2019 - 4Q2019 CMS Utilization Database.accdb"
        strProv = "Microsoft.ACE.OLEDB.12.0;"
        strConn = "Provider=" & strProv & "Data Source=" & strPath
        Conn.Open strConn
        strQry = "DELETE * from " & mb
        rsQry.Open strQry, Conn
        Conn.Execute strQry
        Sheets.Add.Name = "Data"
        
        xlFilepath = Application.ActiveWorkbook.FullName
        strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice]) "
        strQry = strQry & "SELECT NDC11, ProductNameLong, ProductName2, BrandGenericStatus, LicenseTypeName, AWPUnitPrice, WACUnitPrice, [est_ura], [ACA-FULUnitPrice], [ACA-WAMPUnitPrice], [NADAC-MonUnitPrice], [NADAC-WKUnitPrice] "
        strQry = strQry & "FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
        Conn.Execute strQry
        
        
        strQry = "SELECT " & CMS & ".[record_id], " & CMS & ".[state_code], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[ndc], " & CMS & ".[quarter], " & CMS & ".[period_covered], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[units_reimbursed], " & CMS & ".[number_of_prescriptions], " & CMS & ".[total_amount_reimbursed], " & mb & ".[BrandGenericStatus], " & mb & ".[LicenseTypeName], " & mb & ".[AWPUnitPrice], " & mb & ".[WACUnitPrice], " & mb & ".[est_ura], " & mb & ".[ACA-FULUnitPrice], " & mb & ".[ACA-WAMPUnitPrice], " & mb & ".[NADAC-MonUnitPrice], " & mb & ".[NADAC-WKUnitPrice]"
        strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[state_code]) ON [" & mb & "].[NDC11] = " & CMS & ".[ndc]"
        Conn.Execute strQry
        rsQry.Open strQry, Conn
        
        Set ws = ActiveWorkbook.Sheets("Data")
        ws.Range("A1").CopyFromRecordset rsQry
        
        ws.Range("A1").EntireRow.Insert
        ws.Range("A1") = "ID"
        ws.Range("B1") = "ST"
        ws.Range("C1") = "Pool"
        ws.Range("D1") = "MCO Included"
        ws.Range("E1") = "NDC11"
        ws.Range("F1") = "Quarter"
        ws.Range("G1") = "Year"
        ws.Range("H1") = "ProductNameLong"
        ws.Range("I1") = "ProductName2"
        ws.Range("J1") = "Units"
        ws.Range("K1") = "Scripts"
        ws.Range("L1") = "Total Amount"
        ws.Range("M1") = "BrandGenericStatus"
        ws.Range("N1") = "LicenseTypeName"
        ws.Range("O1") = "AWPUnitPrice"
        ws.Range("P1") = "WACUnitPrice"
        ws.Range("Q1") = "est_ura"
        ws.Range("R1") = "ACA-FULUnitPrice"
        ws.Range("S1") = "ACA-WAMPUnitPrice"
        ws.Range("T1") = "NADAC-MonUnitPrice"
        ws.Range("U1") = "NADAC-WKUnitPrice"
        ws.Cells.Columns.AutoFit
        ws.Columns("J:J").NumberFormat = "#,##0"
        ws.Columns("K:K").NumberFormat = "#,##0"
        ws.Columns("L:L").NumberFormat = "$#,##0.#0"
        ws.Range("A1").EntireRow.AutoFilter
        ws.Range("A2").Select
        ActiveWindow.FreezePanes = True
    End If
    
End If
If year = "r2q" Then

    CMS = "[1Q2023 - 4Q2023 CMS Utilization Data]"
    pool = "[State Pools June 2023]"
    mb = "MB_without_financials"
    
    strPath = "Z:\Analytics\Staff\hgarrison\PRM DOCS\1Q2023 - 4Q2023 CMS Utilization Database.accdb"
    strProv = "Microsoft.ACE.OLEDB.12.0;"
    strConn = "Provider=" & strProv & "Data Source=" & strPath
    Conn.Open strConn
    strQry = "DELETE * from " & mb
    rsQry.Open strQry, Conn
    Conn.Execute strQry
    Sheets.Add.Name = "Data"
    
    xlFilepath = Application.ActiveWorkbook.FullName
    strQry = "INSERT INTO " & mb & " (NDC11, ProductNameLong, ProductName2) SELECT NDC11, ProductNameLong, ProductName2 FROM [Excel 12.0;HDR=YES;DATABASE=" & xlFilepath & "].[Sheet1$]"
    Conn.Execute strQry
    
    
    strQry = "SELECT " & CMS & ".[ID], " & CMS & ".[State], " & pool & ".[Pool], " & pool & ".[MCO Included], " & CMS & ".[NDC11], " & CMS & ".[Quarter], " & CMS & ".[Year], " & mb & ".[ProductNameLong], " & mb & ".[ProductName2], " & CMS & ".[Units], " & CMS & ".[Scripts], " & CMS & ".[Total Amount]"
    strQry = strQry & "FROM [" & mb & "] INNER JOIN (" & pool & " INNER JOIN " & CMS & " ON " & pool & ".[St] = " & CMS & ".[State]) ON [" & mb & "].[NDC11] = " & CMS & ".[NDC11]"
    Conn.Execute strQry
    rsQry.Open strQry, Conn
    
    Set ws = ActiveWorkbook.Sheets("Data")
    ws.Range("A1").CopyFromRecordset rsQry
    
    ws.Range("A1").EntireRow.Insert
    ws.Range("A1") = "ID"
    ws.Range("B1") = "ST"
    ws.Range("C1") = "Pool"
    ws.Range("D1") = "MCO Included"
    ws.Range("E1") = "NDC11"
    ws.Range("F1") = "Quarter"
    ws.Range("G1") = "Year"
    ws.Range("H1") = "ProductNameLong"
    ws.Range("I1") = "ProductName2"
    ws.Range("J1") = "Units"
    ws.Range("K1") = "Scripts"
    ws.Range("L1") = "Total Amount"
    ws.Cells.Columns.AutoFit
    ws.Columns("J:J").NumberFormat = "#,##0"
    ws.Columns("K:K").NumberFormat = "#,##0"
    ws.Columns("L:L").NumberFormat = "$#,##0.#0"
    ws.Range("A1").EntireRow.AutoFilter
    ws.Range("A2").Select
    ActiveWindow.FreezePanes = True
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=6, Criteria1:="3"
    Rows("2:999999").Select
    selection.Delete Shift:=xlUp
    ActiveWindow.SmallScroll Down:=540
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=6
    ActiveWindow.SmallScroll Down:=-99999
End If
ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Clear
ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Add2 Key:=Range( _
    "B2:B1703"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Add2 Key:=Range( _
    "F2:F1703"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortTextAsNumbers
ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Add2 Key:=Range( _
    "H2:H1703"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveWorkbook.Worksheets("Data").AutoFilter.Sort
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
End With
Columns("J:J").Select
selection.TextToColumns Destination:=Range("J1"), DataType:=xlDelimited, _
    TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _
    Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
    :=Array(1, 1), TrailingMinusNumbers:=True
Columns("K:K").Select
selection.TextToColumns Destination:=Range("K1"), DataType:=xlDelimited, _
    TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _
    Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
    :=Array(1, 1), TrailingMinusNumbers:=True
Columns("L:L").Select
selection.TextToColumns Destination:=Range("L1"), DataType:=xlDelimited, _
    TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _
    Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
    :=Array(1, 1), TrailingMinusNumbers:=True
    
    
Worksheets("Data").Move After:=Worksheets("Sheet1")
End Sub

Sub Rid_National_Data()
'
' Rid_National_Data Macro
'

'
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=2, Criteria1:="XX"
    Rows("2:999999").Select
    Selection.Delete Shift:=xlUp
    ActiveWindow.SmallScroll Down:=540
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=2
    ActiveWindow.SmallScroll Down:=-99999
End Sub

Sub Select_Specific_States()

Dim state_YesNo
Dim pool_YesNo
Dim id_YesNo
Dim state As String
Dim pool As String
Dim id As String

Worksheets("Data").Copy After:=Worksheets("Data")
ActiveSheet.Name = "Filtered Data"


pool_YesNo = MsgBox("Would you like to specify a pool?", vbYesNo)
If pool_YesNo = vbYes Then
    pool = Application.InputBox("Which pool would you like CMS Utilization Data from: ", "Input Pool")
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=3, Criteria1:="<>" & pool
    Rows("2:999999").Select
    Selection.Delete Shift:=xlUp
    ActiveWindow.SmallScroll Down:=540
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=3
    ActiveWindow.SmallScroll Down:=-99999
End If


state_YesNo = MsgBox("Would you like to specify a state?", vbYesNo)
If state_YesNo = vbYes Then
    state = Application.InputBox("Which state (e.g. AR) would you like CMS Utilization Data from: ", "Input State")
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=2, Criteria1:="<>" & state
    Rows("2:999999").Select
    Selection.Delete Shift:=xlUp
    ActiveWindow.SmallScroll Down:=540
    ActiveSheet.Range("$A:$DD").AutoFilter Field:=2
    ActiveWindow.SmallScroll Down:=-99999
    id_YesNo = MsgBox("Would you like to specify an ID: (FFSU/MCOU)?", vbYesNo)
    If id_YesNo = vbYes Then
        id = Application.InputBox("Which ID would you like CMS Utilization Data from: ", "Input ID")
        ActiveSheet.Range("$A:$DD").AutoFilter Field:=1, Criteria1:="<>" & id
        Rows("2:999999").Select
        Selection.Delete Shift:=xlUp
        ActiveWindow.SmallScroll Down:=540
        ActiveSheet.Range("$A:$DD").AutoFilter Field:=1
        ActiveWindow.SmallScroll Down:=-99999
    End If
End If
    
End Sub

Sub Export_Sheet()
ActiveSheet.Copy
End Sub

Sub UtilizationSummary()
'
' UtilizationSummary Macro
'

'
    With ActiveSheet
    .Copy After:=Sheets(Worksheets.Count)
    End With
    Sheets(Worksheets.Count).Name = "Utilization Summary"

    ActiveSheet.Sort.SortFields.Clear
    ActiveSheet.Sort.SortFields.Add2 Key:=Range("B:B") _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveSheet.Sort.SortFields.Add2 Key:=Range("I:I") _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveSheet.Sort.SortFields.Add2 Key:=Range("A:A") _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveSheet.Sort
        .SetRange Range("A:L")
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    Range("A1").Select
    SendKeys "~"
    ActiveCell.CurrentRegion.Select
    Selection.Subtotal GroupBy:=2, Function:=xlSum, TotalList:=Array(10, 11, 12 _
        ), Replace:=False, PageBreaks:=False, SummaryBelowData:=True
    SendKeys "~"
    Range("A1").Select
    ActiveCell.CurrentRegion.Select
    Selection.Subtotal GroupBy:=9, Function:=xlSum, TotalList:=Array(10, 11, 12 _
        ), Replace:=False, PageBreaks:=False, SummaryBelowData:=True
    SendKeys "~"
    Columns("B:B").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Range("B1").Select
    ActiveCell.FormulaR1C1 = "State"
    Range("B2").Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = "=RC[1]"
    Range("B3").Select
    ActiveCell.FormulaR1C1 = "=IF(RC[1]="""",R[-1]C,RC[1])"
    Range("B3").Select
    'selection.AutoFill Destination:=Range("B3:B" & Range("F" & Rows.Count).End(xlUp).Row)
    Selection.AutoFill Range("B3:B" & Range("F" & Rows.Count).End(xlUp).Row + 3)
    Columns("C:I").Select
    Selection.Columns.Group
    Columns("M:N").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Range("M1").Select
    ActiveCell.FormulaR1C1 = "Units/Rx"
    Range("N1").Select
    ActiveCell.FormulaR1C1 = "Market Share"
    Range("M2").Select
    ActiveCell.FormulaR1C1 = "=IFERROR(RC[-2]/RC[-1],0)"
    Selection.AutoFill Destination:=Range("M2:M" & Range("F" & Rows.Count).End(xlUp).Row + 3)
    Range("M:M").Select
    Range("N2").Select
    ActiveCell.FormulaR1C1 = "=IFERROR(2*RC[-2]/SUMIF(C[-12],RC[-12],C[-2]),0)"
    Range("N2").Select
    Selection.AutoFill Destination:=Range("N2:N" & Range("F" & Rows.Count).End(xlUp).Row + 3)
    Range("N:N").Select
    Columns("M:M").Select
    Selection.Style = "Comma"
    Selection.NumberFormat = "_(* #,##0.0_);_(* (#,##0.0);_(* ""-""??_);_(@_)"
    'selection.NumberFormat = "_(* #,##0_);_(* (#,##0);_(* ""-""??_);_(@_)"
    Columns("N:N").Select
    Selection.Style = "Percent"
    Selection.NumberFormat = "0.0%"
    Selection.NumberFormat = "0.00%"
    ActiveSheet.Outline.ShowLevels RowLevels:=2
    ActiveWindow.SmallScroll Down:=29
    Range("M2:N99999").Select
    Selection.SpecialCells(xlCellTypeVisible).Select
    Selection.ClearContents
    Rows("1:1").Select
    Cells.Select
    With Selection.Interior
        .PatternColorIndex = xlAutomatic
        .ThemeColor = xlThemeColorDark1
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    Range("A1:O1").Select
    With Selection.Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 6299648
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    With Selection.Font
        .ThemeColor = xlThemeColorDark1
        .TintAndShade = 0
    End With
    Range("Q424").Select
    ActiveSheet.Outline.ShowLevels RowLevels:=3
    Cells.Select
    Cells.EntireColumn.AutoFit
    Range("R40").Select
    ActiveWindow.SmallScroll Down:=-29
    ActiveSheet.Outline.ShowLevels ColumnLevels:=1
    Range("B:B").Font.Bold = True
    ActiveWindow.LargeScroll Down:=-99
End Sub

